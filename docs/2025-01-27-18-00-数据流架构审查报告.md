# damon-stack æ•°æ®æµæ¶æ„å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2025å¹´1æœˆ27æ—¥  
**å®¡æŸ¥äºº**: é«˜çº§è½¯ä»¶æ¶æ„å¸ˆ  
**é¡¹ç›®ç‰ˆæœ¬**: v1.0.0  
**å®¡æŸ¥èŒƒå›´**: å…¨æ ˆæ•°æ®æµæ¶æ„

## æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡å®¡æŸ¥å¯¹ damon-stack é¡¹ç›®çš„æ•°æ®æµæ¶æ„è¿›è¡Œäº†å…¨é¢åˆ†æã€‚é¡¹ç›®é‡‡ç”¨äº† **Next.js 15 + tRPC + Prisma** çš„æŠ€æœ¯æ ˆï¼Œæ•´ä½“ä¸Šéµå¾ªäº†åˆ†å±‚æ¶æ„çš„è®¾è®¡åŸåˆ™ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›å…³é”®é¢†åŸŸå­˜åœ¨åç¦»"è§£è€¦æ•°æ®æµ"åŸåˆ™çš„æƒ…å†µï¼Œå¯èƒ½ä¼šå¯¹é¡¹ç›®çš„é•¿æœŸå¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§äº§ç”Ÿå½±å“ã€‚

## å½“å‰æ¶æ„æ¦‚è¿°

### æŠ€æœ¯æ ˆå±‚æ¬¡
1. **å‰ç«¯å±‚**: Next.js 15 App Router + React 19 + Mantine 8
2. **APIå±‚**: tRPC (åŸºäº TypeScript RPC)
3. **ä¸šåŠ¡é€»è¾‘å±‚**: åŠŸèƒ½æ¨¡å— (features/*) + NextAuth.js
4. **æ•°æ®è®¿é—®å±‚**: Prisma ORM
5. **æ•°æ®å­˜å‚¨å±‚**: PostgreSQL

### æ•°æ®æµå‘
```
ç”¨æˆ·ç•Œé¢ â†’ tRPC Client â†’ API Router â†’ Procedures â†’ ä¸šåŠ¡é€»è¾‘ â†’ Prisma â†’ æ•°æ®åº“
```

## å®¡æŸ¥å‘ç°ï¼šè¿åè§£è€¦åŸåˆ™çš„é—®é¢˜

### ğŸ”´ é—®é¢˜1ï¼šä¸šåŠ¡é€»è¾‘ä¸APIå±‚ç´§å¯†è€¦åˆ

**ä½ç½®**: `features/user-management/api/routes.ts`

**é—®é¢˜æè¿°**:
- ä¸šåŠ¡é€»è¾‘ç›´æ¥åµŒå…¥åœ¨ tRPC procedures ä¸­
- æ•°æ®éªŒè¯ã€æƒé™æ£€æŸ¥ã€ä¸šåŠ¡è§„åˆ™å’Œæ•°æ®åº“æ“ä½œæ··åˆåœ¨ä¸€èµ·
- è¿åäº†å•ä¸€èŒè´£åŸåˆ™

**ç¤ºä¾‹ä»£ç **:
```typescript
// âŒ å½“å‰å®ç° - ä¸šåŠ¡é€»è¾‘åµŒå…¥APIå±‚
create: adminProcedure
  .input(userCreateSchema)
  .mutation(async ({ input, ctx }) => {
    // ä¸šåŠ¡è§„åˆ™ï¼šæ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§
    const existingUser = await ctx.db.user.findUnique({
      where: { email: input.email },
    });
    
    if (existingUser) {
      throw new Error(`é‚®ç®± ${input.email} å·²è¢«ä½¿ç”¨`);
    }
    
    // ç›´æ¥æ•°æ®åº“æ“ä½œ
    const user = await ctx.db.user.create({
      data: { ... }
    });
    
    return user;
  })
```

**é£é™©**:
- ä¸šåŠ¡é€»è¾‘æ— æ³•å¤ç”¨
- éš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•
- APIå±‚æ‰¿æ‹…äº†è¿‡å¤šèŒè´£

### ğŸ”´ é—®é¢˜2ï¼šå‰ç«¯ç»„ä»¶ç›´æ¥ä¾èµ–å…·ä½“APIå®ç°

**ä½ç½®**: `apps/admin-dashboard/app/users/page.tsx`

**é—®é¢˜æè¿°**:
- é¡µé¢ç»„ä»¶ç›´æ¥ä½¿ç”¨ tRPC hooks
- æ²¡æœ‰æŠ½è±¡å±‚éš”ç¦»APIè°ƒç”¨ç»†èŠ‚
- UIé€»è¾‘ä¸æ•°æ®è·å–é€»è¾‘æ··åˆ

**ç¤ºä¾‹ä»£ç **:
```typescript
// âŒ å½“å‰å®ç° - ç›´æ¥åœ¨ç»„ä»¶ä¸­ä½¿ç”¨API
function UserManagementContent() {
  const { data: usersData, isLoading } = api.user.list.useQuery({
    limit: 50,
    search: searchQuery || undefined,
  });
  
  const deleteUserMutation = api.user.delete.useMutation({
    onSuccess: () => {
      refetchUsers();
    },
  });
}
```

**é£é™©**:
- æ›´æ¢APIæŠ€æœ¯æ ˆå›°éš¾
- ç»„ä»¶æµ‹è¯•éœ€è¦mockæ•´ä¸ªtRPC
- ä¸šåŠ¡é€»è¾‘åˆ†æ•£åœ¨UIå±‚

### ğŸ”´ é—®é¢˜3ï¼šè·¨å±‚ç›´æ¥è®¿é—®æ•°æ®åº“

**ä½ç½®**: å¤šå¤„ï¼Œå¦‚ `apps/admin-dashboard/auth.ts`

**é—®é¢˜æè¿°**:
- è®¤è¯å±‚ç›´æ¥å¯¼å…¥å’Œä½¿ç”¨ Prisma å®¢æˆ·ç«¯
- æ²¡æœ‰é€šè¿‡æœåŠ¡å±‚æˆ–ä»“å‚¨å±‚è®¿é—®æ•°æ®
- æ•°æ®è®¿é—®é€»è¾‘åˆ†æ•£åœ¨å„å¤„

**ç¤ºä¾‹ä»£ç **:
```typescript
// âŒ å½“å‰å®ç° - ç›´æ¥è®¿é—®æ•°æ®åº“
import { db } from "@damon-stack/db";

async function verifyCredentials(email: string, password: string) {
  const user = await db.user.findUnique({
    where: { email: email.toLowerCase() }
  });
}
```

**é£é™©**:
- æ•°æ®è®¿é—®é€»è¾‘é‡å¤
- éš¾ä»¥å®ç°ç¼“å­˜ã€å®¡è®¡ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹
- æ•°æ®åº“ç»“æ„å˜æ›´å½±å“é¢å¹¿

### ğŸŸ¡ é—®é¢˜4ï¼šåŠŸèƒ½æ¨¡å—è¾¹ç•Œä¸æ¸…æ™°

**ä½ç½®**: `features/*` ç›®å½•ç»“æ„

**é—®é¢˜æè¿°**:
- user-management æ¨¡å—æ··åˆäº†APIå®šä¹‰ã€ç»„ä»¶å’Œç±»å‹
- CMSæ¨¡å—çš„å®ç°åˆ†æ•£åœ¨ features å’Œ apps ä¸­
- ç¼ºå°‘æ¸…æ™°çš„æ¨¡å—æ¥å£å®šä¹‰

**å½“å‰ç»“æ„**:
```
features/
â”œâ”€â”€ user-management/
â”‚   â”œâ”€â”€ api/        # APIè·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ components/ # UIç»„ä»¶
â”‚   â””â”€â”€ types.ts    # ç±»å‹å®šä¹‰
â””â”€â”€ cms/
    â”œâ”€â”€ components/ # åªæœ‰ç»„ä»¶
    â””â”€â”€ types/      # ç±»å‹å®šä¹‰
```

**é£é™©**:
- æ¨¡å—é—´ä¾èµ–å…³ç³»ä¸æ¸…æ™°
- éš¾ä»¥ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•æ¨¡å—
- è¿åäº†æ¨¡å—åŒ–è®¾è®¡åŸåˆ™

### ğŸŸ¡ é—®é¢˜5ï¼šç¼ºå°‘ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

**ä½ç½®**: å…¨å±€

**é—®é¢˜æè¿°**:
- é”™è¯¯å¤„ç†é€»è¾‘åˆ†æ•£åœ¨å„å±‚
- æ²¡æœ‰ç»Ÿä¸€çš„é”™è¯¯ç±»å‹å’Œå¤„ç†ç­–ç•¥
- å‰ç«¯å’Œåç«¯é”™è¯¯å¤„ç†ä¸ä¸€è‡´

**ç¤ºä¾‹**:
```typescript
// åç«¯ï¼šä½¿ç”¨ TRPCError
throw new TRPCError({
  code: 'NOT_FOUND',
  message: 'ç”¨æˆ·ä¸å­˜åœ¨',
});

// å‰ç«¯ï¼šä½¿ç”¨ notifications
notifications.show({
  title: 'é”™è¯¯',
  message: error.message,
  color: 'red',
});
```

### ğŸŸ¡ é—®é¢˜6ï¼šçŠ¶æ€ç®¡ç†åˆ†æ•£

**ä½ç½®**: å‰ç«¯å„ç»„ä»¶

**é—®é¢˜æè¿°**:
- æ²¡æœ‰å…¨å±€çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ
- ä¾èµ– React Query ç¼“å­˜ä½œä¸ºçŠ¶æ€å­˜å‚¨
- ç»„ä»¶é—´çŠ¶æ€å…±äº«å›°éš¾

## æ¶æ„æ”¹è¿›å»ºè®®

### 1. å¼•å…¥æœåŠ¡å±‚ (Service Layer)

```typescript
// âœ… å»ºè®®çš„æ¶æ„
// services/user.service.ts
export class UserService {
  async createUser(data: CreateUserDto): Promise<User> {
    // ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨è¿™é‡Œ
    await this.validateEmailUniqueness(data.email);
    return this.userRepository.create(data);
  }
}

// api/routes/user.ts
create: adminProcedure
  .input(userCreateSchema)
  .mutation(async ({ input, ctx }) => {
    // APIå±‚åªè´Ÿè´£è°ƒç”¨æœåŠ¡
    return ctx.services.user.createUser(input);
  })
```

### 2. å®ç°ä»“å‚¨æ¨¡å¼ (Repository Pattern)

```typescript
// âœ… å»ºè®®çš„æ¶æ„
// repositories/user.repository.ts
export class UserRepository {
  async findByEmail(email: string): Promise<User | null> {
    return db.user.findUnique({
      where: { email: email.toLowerCase() }
    });
  }
  
  async create(data: CreateUserData): Promise<User> {
    return db.user.create({ data });
  }
}
```

### 3. å‰ç«¯æ•°æ®è®¿é—®æŠ½è±¡

```typescript
// âœ… å»ºè®®çš„æ¶æ„
// hooks/useUserManagement.ts
export function useUserManagement() {
  const queryClient = useQueryClient();
  
  const users = useQuery({
    queryKey: ['users'],
    queryFn: () => userService.getUsers(),
  });
  
  const deleteUser = useMutation({
    mutationFn: userService.deleteUser,
    onSuccess: () => {
      queryClient.invalidateQueries(['users']);
    },
  });
  
  return { users, deleteUser };
}
```

### 4. ç»Ÿä¸€é”™è¯¯å¤„ç†

```typescript
// âœ… å»ºè®®çš„æ¶æ„
// lib/errors.ts
export class BusinessError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 400
  ) {
    super(message);
  }
}

// middleware/error-handler.ts
export function errorHandler(error: unknown) {
  if (error instanceof BusinessError) {
    return new Response(error.message, {
      status: error.statusCode,
    });
  }
  // ç»Ÿä¸€å¤„ç†å…¶ä»–é”™è¯¯
}
```

## é£é™©è¯„ä¼°

### é«˜é£é™©é¡¹
1. **æŠ€æœ¯å€ºåŠ¡ç´¯ç§¯**: å½“å‰çš„ç´§è€¦åˆè®¾è®¡ä¼šå¯¼è‡´ä¿®æ”¹æˆæœ¬æŒ‡æ•°çº§å¢é•¿
2. **æµ‹è¯•å›°éš¾**: ä¸šåŠ¡é€»è¾‘ä¸æ¡†æ¶è€¦åˆå¯¼è‡´å•å…ƒæµ‹è¯•å‡ ä¹ä¸å¯èƒ½
3. **æ‰©å±•æ€§å—é™**: æ·»åŠ æ–°åŠŸèƒ½éœ€è¦ä¿®æ”¹å¤šå±‚ä»£ç 

### ä¸­é£é™©é¡¹
1. **å›¢é˜Ÿåä½œéšœç¢**: æ¨¡å—è¾¹ç•Œä¸æ¸…å¯¼è‡´å¹¶è¡Œå¼€å‘å›°éš¾
2. **æ€§èƒ½ä¼˜åŒ–å—é™**: æ— æ³•åœ¨é€‚å½“çš„å±‚æ¬¡å®ç°ç¼“å­˜ç­‰ä¼˜åŒ–
3. **ç»´æŠ¤æˆæœ¬å¢åŠ **: ä»£ç é‡å¤å’Œé€»è¾‘åˆ†æ•£å¢åŠ ç»´æŠ¤éš¾åº¦

## ç»“è®ºä¸å»ºè®®

### ç«‹å³è¡ŒåŠ¨é¡¹
1. **å»ºç«‹æœåŠ¡å±‚**: å°†ä¸šåŠ¡é€»è¾‘ä»APIå±‚æŠ½ç¦»
2. **å®ç°ä»“å‚¨æ¨¡å¼**: ç»Ÿä¸€æ•°æ®è®¿é—®æ¥å£
3. **å®šä¹‰æ¨¡å—è¾¹ç•Œ**: æ˜ç¡®å„åŠŸèƒ½æ¨¡å—çš„èŒè´£å’Œæ¥å£

### ä¸­æœŸæ”¹è¿›é¡¹
1. **å¼•å…¥ä¾èµ–æ³¨å…¥**: å®ç°çœŸæ­£çš„æ§åˆ¶åè½¬
2. **å»ºç«‹é¢†åŸŸæ¨¡å‹**: å°†ä¸šåŠ¡æ¦‚å¿µä¸æ•°æ®åº“ç»“æ„è§£è€¦
3. **å®ç°CQRS**: åˆ†ç¦»å‘½ä»¤å’ŒæŸ¥è¯¢èŒè´£

### é•¿æœŸæ¼”è¿›æ–¹å‘
1. **å¾®æœåŠ¡å‡†å¤‡**: å½“å‰æ¶æ„åº”æ”¯æŒæœªæ¥çš„æœåŠ¡æ‹†åˆ†
2. **äº‹ä»¶é©±åŠ¨**: å¼•å…¥äº‹ä»¶æ€»çº¿å®ç°æ¨¡å—é—´è§£è€¦
3. **é¢†åŸŸé©±åŠ¨è®¾è®¡**: é€æ­¥å‘DDDæ¶æ„æ¼”è¿›

## é™„å½•ï¼šå‚è€ƒæ¶æ„å›¾

### å½“å‰æ¶æ„ï¼ˆå­˜åœ¨è€¦åˆï¼‰
```
ç»„ä»¶ â†’ tRPC Client â†’ API Routes(å«ä¸šåŠ¡é€»è¾‘) â†’ Prisma â†’ DB
```

### å»ºè®®æ¶æ„ï¼ˆè§£è€¦è®¾è®¡ï¼‰
```
ç»„ä»¶ â†’ Hooks â†’ Services â†’ Repositories â†’ Prisma â†’ DB
         â†“
     tRPC Client â†’ API Routes â†’ Services
```

---

**å®¡æŸ¥æ€»ç»“**: è™½ç„¶ damon-stack é¡¹ç›®é‡‡ç”¨äº†ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆï¼Œä½†åœ¨æ•°æ®æµæ¶æ„è®¾è®¡ä¸Šå­˜åœ¨æ˜æ˜¾çš„è€¦åˆé—®é¢˜ã€‚å»ºè®®å°½å¿«å®æ–½æœåŠ¡å±‚å’Œä»“å‚¨æ¨¡å¼ï¼Œä»¥æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚è¿™äº›æ”¹è¿›å°†ä¸ºé¡¹ç›®çš„é•¿æœŸå¥åº·å‘å±•å¥ å®šåšå®åŸºç¡€ã€‚ 