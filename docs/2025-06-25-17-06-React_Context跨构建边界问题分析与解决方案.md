# React Contextè·¨æ„å»ºè¾¹ç•Œé—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## æ—¶é—´
2025-06-25 17:06:25

## é—®é¢˜å‘ç°
åœ¨æˆåŠŸå®æ–½ TSUP æ„å»ºæµç¨‹åï¼Œè¿è¡Œæ—¶å‡ºç° React Context è®¿é—®é”™è¯¯ï¼š

```
Error: @mantine/core: MantineProvider was not found in component tree
    at useMantineTheme (http://localhost:3001/_next/static/chunks/...)
    at useProps (http://localhost:3001/_next/static/chunks/...)
    at @mantine/core/Paper (http://localhost:3001/_next/static/chunks/...)
    at Card (http://localhost:3001/_next/static/chunks/_e870bc54._.js:24:334)
```

## é—®é¢˜æ ¹æœ¬åŸå› 

### React Context è·¨æ„å»ºè¾¹ç•Œé™åˆ¶
è™½ç„¶æˆ‘ä»¬çš„ TSUP é…ç½®å°† React å’Œ @mantine/core æ ‡è®°ä¸º externalï¼Œä½†æ„å»ºäº§ç‰©ä¸­çš„ç»„ä»¶ä»£ç ä»ç„¶åŒ…å«å¯¹ Mantine Context çš„å¼•ç”¨ã€‚è¿™äº›å¼•ç”¨åœ¨è¿è¡Œæ—¶æ— æ³•è·¨è¶Šæ„å»ºè¾¹ç•Œè®¿é—®ä¸»åº”ç”¨çš„ MantineProviderã€‚

### æŠ€æœ¯å±‚é¢åˆ†æ
```
ä¸»åº”ç”¨ (apps/admin-dashboard)
â”œâ”€â”€ MantineProvider Context (Provider Instance A)
â”œâ”€â”€ ç›´æ¥ä½¿ç”¨çš„ Mantine ç»„ä»¶ âœ… å¯ä»¥è®¿é—® Context
â””â”€â”€ å¼•ç”¨çš„æ„å»ºäº§ç‰©
    â””â”€â”€ @damon-stack/ui/dist
        â””â”€â”€ Card ç»„ä»¶
            â””â”€â”€ å†…éƒ¨çš„ Paper ç»„ä»¶ âŒ æ— æ³•è®¿é—® Context
```

### é—®é¢˜ç»†èŠ‚
1. **æ„å»ºéš”ç¦»**: è™½ç„¶ä¾èµ–å¤–éƒ¨åŒ–ï¼Œä½†ç»„ä»¶ä»£ç ä»åœ¨ç‹¬ç«‹çš„æ¨¡å—ä½œç”¨åŸŸä¸­
2. **Context è¾¹ç•Œ**: React Context æ— æ³•è·¨è¶Šæ¨¡å—è¾¹ç•Œä¼ é€’
3. **è¿è¡Œæ—¶è§£æ**: æ„å»ºäº§ç‰©åœ¨è¿è¡Œæ—¶å¯»æ‰¾è‡ªå·±çš„ Context å®ä¾‹

## è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆä¸€ï¼šä¸´æ—¶ä¿®å¤ âš¡ï¼ˆå·²å®æ–½ï¼‰
**åšæ³•**: åœ¨ä¸»åº”ç”¨ä¸­ç›´æ¥ä½¿ç”¨ Mantine åŸç”Ÿç»„ä»¶ï¼Œé¿å…ä½¿ç”¨è‡ªå®šä¹‰çš„ Card ç»„ä»¶
```typescript
// æ›¿æ¢å‰
import { Card } from '@damon-stack/ui';
<Card title="æ ‡é¢˜">å†…å®¹</Card>

// æ›¿æ¢å  
import { Paper, Title } from '@mantine/core';
<Paper shadow="sm" p="lg" radius="md" withBorder>
  <Title order={3} mb="md">æ ‡é¢˜</Title>
  å†…å®¹
</Paper>
```

**ä¼˜åŠ¿**:
- âœ… ç«‹å³è§£å†³é—®é¢˜
- âœ… é›¶é…ç½®æ›´æ”¹
- âœ… æ€§èƒ½æ— æŸå¤±

**åŠ£åŠ¿**:
- âŒ å¤±å»äº†ç»„ä»¶æŠ½è±¡çš„ä»·å€¼
- âŒ ä»£ç é‡å¤å’Œç»´æŠ¤æˆæœ¬
- âŒ ä¸æ˜¯é•¿æœŸå¯æŒç»­æ–¹æ¡ˆ

### æ–¹æ¡ˆäºŒï¼šProps æ³¨å…¥æ¨¡å¼ ğŸ”§
**åšæ³•**: ä¿®æ”¹ Card ç»„ä»¶ï¼Œä¸ä¾èµ– Contextï¼Œé€šè¿‡ props ä¼ é€’æ ·å¼
```typescript
// packages/ui/src/Card.tsx
interface CardProps {
  title?: React.ReactNode;
  children: React.ReactNode;
  shadow?: string;
  padding?: string;
  radius?: string;
  withBorder?: boolean;
  // å…¶ä»–æ ·å¼ props
}

const Card: React.FC<CardProps> = ({ 
  title, 
  children, 
  shadow = 'sm',
  padding = 'lg',
  radius = 'md',
  withBorder = true,
  ...rest 
}) => {
  return (
    <div 
      style={{
        boxShadow: shadow === 'sm' ? '0 1px 3px rgba(0,0,0,0.12)' : '...',
        padding: padding === 'lg' ? '1rem' : '...',
        borderRadius: radius === 'md' ? '0.5rem' : '...',
        border: withBorder ? '1px solid #e9ecef' : 'none',
        ...rest.style
      }}
      {...rest}
    >
      {title && <h3>{title}</h3>}
      {children}
    </div>
  );
};
```

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨é¿å… Context ä¾èµ–
- âœ… å¯é¢„æµ‹çš„è¡Œä¸º
- âœ… æ›´å¥½çš„å¯ç§»æ¤æ€§

**åŠ£åŠ¿**:
- âŒ å¤±å» Mantine ä¸»é¢˜ç³»ç»Ÿçš„ä¼˜åŠ¿
- âŒ éœ€è¦é‡æ–°å®ç°æ ·å¼é€»è¾‘
- âŒ ç»´æŠ¤å¤æ‚åº¦å¢åŠ 

### æ–¹æ¡ˆä¸‰ï¼šCompound Components æ¨¡å¼ ğŸ—ï¸
**åšæ³•**: æä¾›ä¸¤ä¸ªç‰ˆæœ¬çš„ç»„ä»¶ï¼šContext ä¾èµ–ç‰ˆæœ¬å’Œç‹¬ç«‹ç‰ˆæœ¬
```typescript
// packages/ui/src/index.ts
export { default as Card } from './Card';          // Context ä¾èµ–ç‰ˆæœ¬
export { default as SimpleCard } from './SimpleCard'; // ç‹¬ç«‹ç‰ˆæœ¬

// ä½¿ç”¨æ—¶
import { SimpleCard } from '@damon-stack/ui';  // è·¨åŒ…ä½¿ç”¨
import { Card } from '@mantine/core';          // åŒ…å†…ä½¿ç”¨
```

**ä¼˜åŠ¿**:
- âœ… çµæ´»æ€§æœ€é«˜
- âœ… å‘åå…¼å®¹
- âœ… æ¸è¿›å¼è¿ç§»

**åŠ£åŠ¿**:
- âŒ API å¤æ‚åº¦å¢åŠ 
- âŒ æ–‡æ¡£å’Œç»´æŠ¤æˆæœ¬
- âŒ å¼€å‘è€…å›°æƒ‘é£é™©

### æ–¹æ¡ˆå››ï¼šè¿è¡Œæ—¶ Context æ¡¥æ¥ ğŸŒ‰
**åšæ³•**: é€šè¿‡é«˜é˜¶ç»„ä»¶æˆ– Provider åŒ…è£…å™¨è§£å†³ Context ä¼ é€’
```typescript
// packages/ui/src/withMantineProvider.tsx
export function withMantineProvider<T>(Component: React.ComponentType<T>) {
  return function WrappedComponent(props: T) {
    return (
      <MantineProvider>
        <Component {...props} />
      </MantineProvider>
    );
  };
}

// æˆ–ä½¿ç”¨ React.cloneElement æ³¨å…¥ Context
```

**ä¼˜åŠ¿**:
- âœ… ä¿æŒåŸæœ‰ API
- âœ… è§£å†³ Context é—®é¢˜
- âœ… å¯æ‰©å±•æ€§å¥½

**åŠ£åŠ¿**:
- âŒ æ€§èƒ½å¼€é”€ï¼ˆå¤šå±‚ Providerï¼‰
- âŒ å¤æ‚çš„å®ç°é€»è¾‘
- âŒ å¯èƒ½çš„ä¸»é¢˜å†²çª

### æ–¹æ¡ˆäº”ï¼šæ„å»ºæ—¶ Context é¢„å¤„ç† âš™ï¸
**åšæ³•**: ä¿®æ”¹ TSUP é…ç½®ï¼Œåœ¨æ„å»ºæ—¶å¤„ç† Context å¼•ç”¨
```typescript
// tsup.config.ts
export default defineConfig({
  // ... å…¶ä»–é…ç½®
  esbuildOptions: (options) => {
    options.define = {
      ...options.define,
      // åœ¨æ„å»ºæ—¶æ›¿æ¢ Context è®¿é—®
      'useMantineTheme': 'undefined',
      'useProps': 'undefined'
    };
  },
  // ä½¿ç”¨ babel æ’ä»¶ç§»é™¤ Context è°ƒç”¨
  plugins: [
    {
      name: 'remove-context-calls',
      setup(build) {
        // è‡ªå®šä¹‰ babel è½¬æ¢é€»è¾‘
      }
    }
  ]
});
```

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨è‡ªåŠ¨åŒ–
- âœ… é›¶è¿è¡Œæ—¶å¼€é”€
- âœ… ä¿æŒåŸæœ‰å¼€å‘ä½“éªŒ

**åŠ£åŠ¿**:
- âŒ æ„å»ºé…ç½®å¤æ‚
- âŒ è°ƒè¯•å›°éš¾
- âŒ ç»´æŠ¤é£é™©é«˜

## æ¨èè§£å†³æ–¹æ¡ˆ

### çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å®æ–½ï¼‰
**ä½¿ç”¨æ–¹æ¡ˆä¸€**ï¼šä¸´æ—¶ä¿®å¤ï¼Œç›´æ¥ä½¿ç”¨ Mantine åŸç”Ÿç»„ä»¶
- å¿«é€Ÿè§£å†³é—®é¢˜ï¼Œç¡®ä¿åº”ç”¨æ­£å¸¸è¿è¡Œ
- ä¸ºé•¿æœŸæ–¹æ¡ˆæä¾›æ—¶é—´ç¼“å†²

### ä¸­æœŸæ–¹æ¡ˆï¼ˆ1-2å‘¨å†…ï¼‰
**å®æ–½æ–¹æ¡ˆä¸‰**ï¼šCompound Components æ¨¡å¼
```typescript
// packages/ui/src/index.ts
export { default as Card } from './Card';              // å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬
export { default as StandaloneCard } from './StandaloneCard'; // ç‹¬ç«‹ç‰ˆæœ¬

// ä¸»åº”ç”¨ä½¿ç”¨
import { StandaloneCard as Card } from '@damon-stack/ui';
```

### é•¿æœŸæ–¹æ¡ˆï¼ˆæœªæ¥è¿­ä»£ï¼‰
**é‡‡ç”¨æ–¹æ¡ˆäºŒ**ï¼šProps æ³¨å…¥æ¨¡å¼ + ä¸»é¢˜ç³»ç»Ÿ
- æ„å»ºç‹¬ç«‹çš„è®¾è®¡ç³»ç»Ÿ
- å®ç°ä¸ Mantine å…¼å®¹çš„æ ·å¼ API
- æä¾›æ›´å¥½çš„å¯ç§»æ¤æ€§

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šç¨³å®šåŒ–ï¼ˆå·²å®Œæˆï¼‰
- âœ… ä¿®æ”¹ä¸»é¡µé¢ï¼Œä½¿ç”¨ Paper ç»„ä»¶æ›¿ä»£ Card
- âœ… ç¡®ä¿åº”ç”¨æ­£å¸¸è¿è¡Œ
- âœ… ä¿æŒç°æœ‰åŠŸèƒ½å®Œæ•´æ€§

### ç¬¬äºŒé˜¶æ®µï¼šæ¶æ„ä¼˜åŒ–ï¼ˆå¾…å®æ–½ï¼‰
1. **åˆ›å»º StandaloneCard ç»„ä»¶**
   ```typescript
   // packages/ui/src/StandaloneCard.tsx
   // ä¸ä¾èµ– Mantine Context çš„å¡ç‰‡ç»„ä»¶
   ```

2. **æ›´æ–°å¯¼å‡ºé…ç½®**
   ```typescript
   // packages/ui/src/index.ts
   export { default as Card } from './Card';
   export { default as StandaloneCard } from './StandaloneCard';
   ```

3. **æ–‡æ¡£å’Œç¤ºä¾‹**
   - åˆ›å»ºä½¿ç”¨æŒ‡å—
   - æä¾›è¿ç§»è·¯å¾„
   - æ›´æ–° UI-test é¡µé¢

### ç¬¬ä¸‰é˜¶æ®µï¼šå¼€å‘è€…ä½“éªŒï¼ˆæœªæ¥ï¼‰
1. **æ„å»ºå·¥å…·ä¼˜åŒ–**
   - è‡ªåŠ¨æ£€æµ‹ Context ä½¿ç”¨
   - æ„å»ºæ—¶è­¦å‘Šå’Œå»ºè®®
   - æ›´å¥½çš„é”™è¯¯ä¿¡æ¯

2. **ç±»å‹ç³»ç»Ÿæ”¹è¿›**
   - æ˜ç¡®çš„ API åŒºåˆ†
   - æ›´å¥½çš„ TypeScript æ”¯æŒ
   - è‡ªåŠ¨åŒ–ç±»å‹ç”Ÿæˆ

## ç»éªŒæ€»ç»“

### å…³é”®æŠ€æœ¯æ´å¯Ÿ
1. **å¤–éƒ¨ä¾èµ–é…ç½®ä¸è¶³ä»¥è§£å†³ Context é—®é¢˜**ï¼šå³ä½¿ React è¢«æ­£ç¡®å¤–éƒ¨åŒ–ï¼ŒContext ä»ç„¶æ— æ³•è·¨æ„å»ºè¾¹ç•Œä¼ é€’
2. **Monorepo æ¶æ„çš„ Context æŒ‘æˆ˜**ï¼šè·¨åŒ…å…±äº«æœ‰çŠ¶æ€ç»„ä»¶éœ€è¦ç‰¹æ®Šè®¾è®¡
3. **æ„å»ºæ—¶ vs è¿è¡Œæ—¶**ï¼šæ„å»ºé…ç½®æ­£ç¡®ä¸æ„å‘³ç€è¿è¡Œæ—¶è¡Œä¸ºæ­£ç¡®

### è®¾è®¡åŸåˆ™æ•™è®­
1. **é¿å…è·¨åŒ… Context ä¾èµ–**ï¼šå…±äº«ç»„ä»¶åº”è¯¥å°½å¯èƒ½ç‹¬ç«‹
2. **æ¸è¿›å¼è§£å†³æ–¹æ¡ˆ**ï¼šæä¾›å¤šç§ä½¿ç”¨æ¨¡å¼ä»¥é€‚åº”ä¸åŒåœºæ™¯
3. **æ˜ç¡®çš„è¾¹ç•Œå®šä¹‰**ï¼šæ¸…æ¥šåœ°å®šä¹‰ä»€ä¹ˆå¯ä»¥è·¨åŒ…å…±äº«ï¼Œä»€ä¹ˆä¸èƒ½

### å·¥ç¨‹å®è·µæ”¹è¿›
1. **æ—©æœŸåŸå‹éªŒè¯**ï¼šåœ¨å®Œæ•´å®æ–½å‰éªŒè¯è·¨åŒ…ç»„ä»¶çš„å¯è¡Œæ€§
2. **åˆ†å±‚æ¶æ„è®¾è®¡**ï¼šåŒºåˆ†åŸºç¡€ç»„ä»¶ã€ä¸šåŠ¡ç»„ä»¶å’Œåº”ç”¨ç‰¹å®šç»„ä»¶
3. **å…¨é¢çš„æµ‹è¯•ç­–ç•¥**ï¼šåŒ…æ‹¬æ„å»ºåçš„é›†æˆæµ‹è¯•

## åç»­è¡ŒåŠ¨é¡¹

### ç«‹å³è¡ŒåŠ¨
- âœ… éªŒè¯ä¿®å¤åçš„åº”ç”¨æ­£å¸¸è¿è¡Œ
- â³ åˆ›å»º StandaloneCard ç»„ä»¶
- â³ æ›´æ–°æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—

### ä¸­æœŸè§„åˆ’
- â³ é‡æ–°è®¾è®¡å…±äº«ç»„ä»¶æ¶æ„
- â³ å»ºç«‹è·¨åŒ…ç»„ä»¶çš„æœ€ä½³å®è·µ
- â³ ä¼˜åŒ–å¼€å‘å·¥ä½œæµ

### é•¿æœŸæ„¿æ™¯
- â³ æ„å»ºä¼ä¸šçº§è®¾è®¡ç³»ç»Ÿ
- â³ å®ç°å®Œå…¨çš„ä¸»é¢˜ç³»ç»Ÿ
- â³ æä¾›å¤šæ¡†æ¶æ”¯æŒ

è¿™ä¸ªé—®é¢˜æš´éœ²äº† monorepo æ¶æ„ä¸­ React Context ç®¡ç†çš„å¤æ‚æ€§ï¼Œä½†ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†å®è´µçš„å­¦ä¹ æœºä¼šå’Œæ”¹è¿›æ–¹å‘ã€‚ 