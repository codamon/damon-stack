# å‰ç«¯æƒé™æ§åˆ¶ç³»ç»Ÿ (UI RBAC) å®ç°å®Œæˆ

**åˆ›å»ºæ—¶é—´**: 2025-06-25 22:27  
**ä½œè€…**: AI Assistant  
**é¡¹ç›®**: damon-stack Admin ç³»ç»Ÿ  
**æŠ€æœ¯æ ˆ**: Next.js 15, React 19, Mantine 8, NextAuth.js, TypeScript

## å®ç°æ¦‚è¿°

æˆåŠŸä¸º damon-stack Admin ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„å‰ç«¯åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (UI RBAC) åŠŸèƒ½ï¼Œç¡®ä¿ UI ç•Œé¢æ ¹æ®ç”¨æˆ·æƒé™åŠ¨æ€æ˜¾ç¤º/éšè—åŠŸèƒ½ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. è‡ªå®šä¹‰æƒé™ Hook

#### `useCurrentUser`
- **æ–‡ä»¶ä½ç½®**: `apps/admin-dashboard/hooks/use-current-user.ts`
- **åŠŸèƒ½**: ç»Ÿä¸€ç®¡ç†ç”¨æˆ·ä¿¡æ¯å’Œæƒé™çŠ¶æ€
- **è¿”å›å€¼**:
  - `user`: å½“å‰ç”¨æˆ·ä¿¡æ¯
  - `isAuthenticated`: æ˜¯å¦å·²ç™»å½•
  - `isAdmin`: æ˜¯å¦ä¸ºç®¡ç†å‘˜
  - `hasRole(role)`: æ£€æŸ¥ç‰¹å®šè§’è‰²
  - `canManageUsers`: æ˜¯å¦å¯ç®¡ç†ç”¨æˆ·
  - `canAccessAdmin`: æ˜¯å¦å¯è®¿é—®ç®¡ç†åŠŸèƒ½

#### `usePermissionGuard`
- **åŠŸèƒ½**: æƒé™å®ˆå«ï¼Œç”¨äºé¡µé¢çº§æƒé™æ£€æŸ¥
- **ç‰¹æ€§**: æ”¯æŒæƒé™ä¸è¶³æ—¶çš„é‡å®šå‘

#### `useConditionalRender`
- **åŠŸèƒ½**: æ¡ä»¶æ¸²æŸ“å·¥å…·
- **æ–¹æ³•**: 
  - `renderIfAdmin`: ä»…ç®¡ç†å‘˜å¯è§
  - `renderIfAuthenticated`: ä»…ç™»å½•ç”¨æˆ·å¯è§
  - `renderIfRole`: ç‰¹å®šè§’è‰²å¯è§

### 2. ä¾§è¾¹æ èœå•æƒé™æ§åˆ¶

#### å¯¼èˆªèœå•é…ç½®
```typescript
const navigationItems = [
  {
    label: 'ä»ªè¡¨ç›˜',
    href: '/dashboard',
    icon: IconDashboard,
    requireRole: null, // æ‰€æœ‰ç™»å½•ç”¨æˆ·å¯è®¿é—®
  },
  {
    label: 'ç”¨æˆ·ç®¡ç†',
    href: '/users',
    icon: IconUsers,
    requireRole: 'admin', // ğŸ”’ ä»…ç®¡ç†å‘˜å¯è®¿é—®
  },
  // ...å…¶ä»–èœå•é¡¹
];
```

#### åŠ¨æ€æƒé™æ£€æŸ¥
```typescript
// æƒé™æ£€æŸ¥é€»è¾‘
const hasRequiredPermission = item.requireRole 
  ? hasRole(item.requireRole) 
  : isAuthenticated;

// æ¡ä»¶æ¸²æŸ“
if (!hasRequiredPermission) {
  return null; // ä¸æ¸²æŸ“è¯¥èœå•é¡¹
}
```

### 3. ç”¨æˆ·ç®¡ç†é¡µé¢æƒé™ä¿æŠ¤

#### æƒé™é—¨å«ç»„ä»¶
```typescript
function PermissionGate({ children }: { children: React.ReactNode }) {
  const { isAdmin, isLoading, user } = useCurrentUser();

  if (!isAdmin) {
    return <AccessDeniedMessage />;
  }

  return <>{children}</>;
}
```

#### æ“ä½œæŒ‰é’®æƒé™æ§åˆ¶
- **åˆ›å»ºç”¨æˆ·æŒ‰é’®**: `{isAdmin && <CreateButton />}`
- **ç¼–è¾‘æ“ä½œ**: `{isAdmin && <EditAction />}`
- **åˆ é™¤æ“ä½œ**: `{isAdmin && <DeleteAction />}`
- **æ“ä½œåˆ—**: `{isAdmin && <Table.Th>æ“ä½œ</Table.Th>}`

## æŠ€æœ¯æ¶æ„ç‰¹ç‚¹

### 1. å¤šå±‚æƒé™æ£€æŸ¥
```typescript
// 1. Hook çº§åˆ«æ£€æŸ¥
const { isAdmin } = useCurrentUser();

// 2. ç»„ä»¶çº§åˆ«æ£€æŸ¥
if (!isAdmin) return <AccessDenied />;

// 3. æ“ä½œçº§åˆ«æ£€æŸ¥
const handleDelete = () => {
  if (!isAdmin) {
    alert('æƒé™ä¸è¶³');
    return;
  }
  // æ‰§è¡Œåˆ é™¤
};
```

### 2. ç±»å‹å®‰å…¨
- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- æ‰©å±• NextAuth ç”¨æˆ·æ¥å£
- æƒé™çŠ¶æ€çš„ç±»å‹æ¨æ–­

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- åŠ è½½çŠ¶æ€ç®¡ç†
- æƒé™éªŒè¯æ—¶çš„åŠ è½½æŒ‡ç¤ºå™¨
- å‹å¥½çš„æƒé™ä¸è¶³æç¤º
- å¹³æ»‘çš„ UI çŠ¶æ€åˆ‡æ¢

### 4. æ€§èƒ½ä¼˜åŒ–
- Hook å¤ç”¨é¿å…é‡å¤è®¡ç®—
- æ¡ä»¶æ¸²æŸ“å‡å°‘ DOM èŠ‚ç‚¹
- åŸºäº NextAuth çš„é«˜æ•ˆ session ç®¡ç†

## å®ç°ç»†èŠ‚

### æƒé™éªŒè¯æµç¨‹
1. **é¡µé¢åŠ è½½** â†’ è·å–ç”¨æˆ· session
2. **æƒé™è®¡ç®—** â†’ åŸºäºç”¨æˆ·è§’è‰²è®¡ç®—æƒé™
3. **UI æ¸²æŸ“** â†’ æ ¹æ®æƒé™åŠ¨æ€æ¸²æŸ“ç•Œé¢
4. **æ“ä½œæ‹¦æˆª** â†’ æ“ä½œå‰å†æ¬¡éªŒè¯æƒé™

### å®‰å…¨è®¾è®¡åŸåˆ™
1. **é»˜è®¤æ‹’ç»**: é»˜è®¤éšè—æ•æ„ŸåŠŸèƒ½
2. **æ˜¾å¼æˆæƒ**: æ˜ç¡®å£°æ˜æ‰€éœ€æƒé™
3. **å¤šå±‚é˜²æŠ¤**: UI + æ“ä½œ + API ä¸‰é‡æ£€æŸ¥
4. **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„æƒé™æç¤ºä¿¡æ¯

## æƒé™æ§åˆ¶çŸ©é˜µ

| åŠŸèƒ½ | æœªç™»å½• | æ™®é€šç”¨æˆ· | ç®¡ç†å‘˜ |
|------|--------|----------|--------|
| æŸ¥çœ‹ä»ªè¡¨ç›˜ | âŒ | âœ… | âœ… |
| æŸ¥çœ‹ç”¨æˆ·ç®¡ç†èœå• | âŒ | âŒ | âœ… |
| è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢ | âŒ | âŒ | âœ… |
| æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ | âŒ | âŒ | âœ… |
| åˆ›å»ºç”¨æˆ· | âŒ | âŒ | âœ… |
| ç¼–è¾‘ç”¨æˆ· | âŒ | âŒ | âœ… |
| åˆ é™¤ç”¨æˆ· | âŒ | âŒ | âœ… |
| æŸ¥çœ‹ç”¨æˆ·ç»Ÿè®¡ | âŒ | âŒ | âœ… |

## ä»£ç ç¤ºä¾‹

### åŸºç¡€æƒé™æ£€æŸ¥
```typescript
function MyComponent() {
  const { isAdmin, isLoading, user } = useCurrentUser();
  
  if (isLoading) return <Skeleton />;
  
  return (
    <div>
      <p>æ¬¢è¿, {user?.name}</p>
      {isAdmin && <AdminPanel />}
    </div>
  );
}
```

### æƒé™å®ˆå«
```typescript
function AdminOnlyPage() {
  const { hasPermission } = usePermissionGuard('admin');
  
  if (!hasPermission) {
    return <AccessDeniedPage />;
  }
  
  return <AdminContent />;
}
```

### æ¡ä»¶æ¸²æŸ“
```typescript
function UserActions({ userId }: { userId: string }) {
  const { renderIfAdmin } = useConditionalRender();
  
  return (
    <Group>
      {renderIfAdmin(
        <Button onClick={() => editUser(userId)}>
          ç¼–è¾‘
        </Button>
      )}
      {renderIfAdmin(
        <Button onClick={() => deleteUser(userId)}>
          åˆ é™¤
        </Button>
      )}
    </Group>
  );
}
```

## å·²ä¿®æ”¹æ–‡ä»¶

### 1. æ–°å¢æ–‡ä»¶
- `apps/admin-dashboard/hooks/use-current-user.ts` - æƒé™ç®¡ç† Hook

### 2. ä¿®æ”¹æ–‡ä»¶
- `apps/admin-dashboard/components/Layout.tsx` - ä¾§è¾¹æ æƒé™æ§åˆ¶
- `apps/admin-dashboard/app/users/page.tsx` - ç”¨æˆ·ç®¡ç†é¡µé¢æƒé™ä¿æŠ¤

## å®‰å…¨ç‰¹æ€§

### 1. å‰ç«¯å®‰å…¨
- æ•æ„ŸåŠŸèƒ½é»˜è®¤éšè—
- æƒé™çŠ¶æ€å®æ—¶åŒæ­¥
- æ“ä½œå‰æƒé™éªŒè¯

### 2. ç”¨æˆ·ä½“éªŒ
- å¹³æ»‘çš„æƒé™åˆ‡æ¢
- æ¸…æ™°çš„æƒé™æç¤º
- åŠ è½½çŠ¶æ€ç®¡ç†

### 3. å¼€å‘å‹å¥½
- Hook å¤ç”¨æ€§å¼º
- ç±»å‹å®‰å…¨ä¿éšœ
- æ˜“äºæ‰©å±•ç»´æŠ¤

## æ‰©å±•èƒ½åŠ›

### 1. æ–°å¢æƒé™è§’è‰²
```typescript
// åœ¨ useCurrentUser ä¸­æ·»åŠ æ–°è§’è‰²æ£€æŸ¥
const isEditor = userRole === 'editor';
const isModerator = userRole === 'moderator';
```

### 2. ç»†ç²’åº¦æƒé™
```typescript
// åŸºäºæƒé™è€Œéè§’è‰²çš„æ£€æŸ¥
const hasPermission = (permission: string) => {
  return user?.permissions?.includes(permission);
};
```

### 3. èµ„æºçº§æƒé™
```typescript
// æ£€æŸ¥æ˜¯å¦ä¸ºèµ„æºæ‰€æœ‰è€…
const canEdit = (resourceOwnerId: string) => {
  return user?.id === resourceOwnerId || isAdmin;
};
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **æƒé™æ£€æŸ¥å¤±æ•ˆ**: ç¡®è®¤ NextAuth session æ­£å¸¸
2. **UI é—ªçƒ**: æ·»åŠ åŠ è½½çŠ¶æ€å¤„ç†
3. **æƒé™æ›´æ–°å»¶è¿Ÿ**: æ£€æŸ¥ session æ›´æ–°æœºåˆ¶

### è°ƒè¯•æ–¹æ³•
```typescript
// åœ¨ç»„ä»¶ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—
const { user, isAdmin } = useCurrentUser();
console.log('ç”¨æˆ·ä¿¡æ¯:', user);
console.log('æ˜¯å¦ç®¡ç†å‘˜:', isAdmin);
```

## æ€§èƒ½ç›‘æ§

### å…³é”®æŒ‡æ ‡
- Hook è°ƒç”¨æ¬¡æ•°
- æƒé™æ£€æŸ¥å»¶è¿Ÿ
- UI æ¸²æŸ“æ€§èƒ½
- Session è·å–æ—¶é—´

## æ€»ç»“

âœ… **å®ŒæˆåŠŸèƒ½**:
- è‡ªå®šä¹‰æƒé™ç®¡ç† Hook
- ä¾§è¾¹æ èœå•æƒé™æ§åˆ¶
- ç”¨æˆ·ç®¡ç†é¡µé¢æƒé™ä¿æŠ¤
- æ“ä½œæŒ‰é’®æƒé™æ§åˆ¶
- å®Œæ•´çš„æƒé™éªŒè¯æµç¨‹

âœ… **æŠ€æœ¯ç‰¹ç‚¹**:
- åŸºäº NextAuth.js çš„æƒé™ç³»ç»Ÿ
- å¤šå±‚æƒé™éªŒè¯æœºåˆ¶
- TypeScript ç±»å‹å®‰å…¨
- ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ
- æ˜“äºæ‰©å±•çš„æ¶æ„

ğŸ¯ **å®‰å…¨ä¿éšœ**:
- å‰ç«¯ + åç«¯åŒé‡ä¿æŠ¤
- é»˜è®¤æ‹’ç»ç­–ç•¥
- å®æ—¶æƒé™éªŒè¯
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

---
**ç»´æŠ¤è¯´æ˜**: å‰ç«¯æƒé™æ§åˆ¶æ˜¯ç”¨æˆ·ä½“éªŒçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä½†ä¸èƒ½æ›¿ä»£åç«¯æƒé™éªŒè¯ï¼Œä¸¤è€…éœ€è¦é…åˆä½¿ç”¨ä»¥ç¡®ä¿ç³»ç»Ÿå®‰å…¨ã€‚ 