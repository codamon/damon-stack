# CMSæ–‡ç« ç®¡ç†æ¨¡å—å¼€å‘ä¸Next.js 15å…¼å®¹æ€§ä¿®å¤

**æ—¶é—´**: 2025-06-26 09:03  
**é¡¹ç›®**: damon-stack Monorepo  
**æŠ€æœ¯æ ˆ**: Next.js 15, React 19, Mantine 8, tRPC, Prisma

## èƒŒæ™¯

åœ¨å‰ä¸€æ¬¡å¯¹è¯ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº† CMS åˆ†ç±»ç®¡ç†æ¨¡å—å’Œå¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆã€‚æœ¬æ¬¡ä»»åŠ¡æ˜¯å¼€å‘å®Œæ•´çš„æ–‡ç« ç®¡ç†æ¨¡å—ï¼Œä½†åœ¨è¿‡ç¨‹ä¸­é‡åˆ°äº†å¤šä¸ª Next.js 15 çš„å…¼å®¹æ€§é—®é¢˜ã€‚

## å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ•°æ®æ¨¡å‹è®¾è®¡

**Post æ¨¡å‹**ï¼ˆæ–‡ç« è¡¨ `cms_posts`ï¼‰ï¼š
```prisma
model Post {
  id              String      @id @default(cuid())
  title           String
  slug            String      @unique
  content         String      @db.Text
  excerpt         String?     @db.Text
  coverImage      String?
  status          PostStatus  @default(DRAFT)
  metaTitle       String?
  metaDescription String?     @db.Text
  keywords        String?
  viewCount       Int         @default(0)
  likeCount       Int         @default(0)
  order           Int         @default(0)
  featured        Boolean     @default(false)
  publishedAt     DateTime?
  scheduledAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  authorId        String
  categoryId      String?
  
  // å…³è”å…³ç³»
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags     PostTag[]
  
  // ç´¢å¼•ä¼˜åŒ–
  @@index([status, publishedAt])
  @@index([categoryId])
  @@index([authorId])
  @@index([featured])
  @@map("cms_posts")
}
```

**Tag æ¨¡å‹**ï¼ˆæ ‡ç­¾è¡¨ `cms_tags`ï¼‰ï¼š
```prisma
model Tag {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?   @db.Text
  color       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  posts       PostTag[]
  
  @@map("cms_tags")
}
```

**PostTag å…³è”è¡¨**ï¼š
```prisma
model PostTag {
  postId String
  tagId  String
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([postId, tagId])
  @@map("cms_post_tags")
}
```

### 2. tRPC API è·¯ç”±

åˆ›å»ºäº†å®Œæ•´çš„ `postRouter`ï¼ŒåŒ…å«ï¼š

**æŸ¥è¯¢æ“ä½œ**ï¼š
- `list` - åˆ†é¡µåˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢ã€ç­›é€‰ã€æ’åºï¼‰
- `getById` - æ ¹æ®IDè·å–å•ç¯‡æ–‡ç« 

**å†™å…¥æ“ä½œ**ï¼š
- `create` - åˆ›å»ºæ–°æ–‡ç« 
- `update` - æ›´æ–°æ–‡ç« 
- `delete` - åˆ é™¤æ–‡ç« 
- `batchDelete` - æ‰¹é‡åˆ é™¤

**çŠ¶æ€ç®¡ç†**ï¼š
- `updateStatus` - æ›´æ–°æ–‡ç« çŠ¶æ€
- `incrementViewCount` - å¢åŠ æµè§ˆæ¬¡æ•°

**æ™ºèƒ½åŠŸèƒ½**ï¼š
- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ slug
- å‘å¸ƒæ—¶é—´è‡ªåŠ¨è®¾ç½®
- æ ‡ç­¾å…³è”ç®¡ç†

### 3. å‰ç«¯é¡µé¢å¼€å‘

**æ–‡ç« åˆ—è¡¨é¡µ** (`/cms/posts`)ï¼š
- ä½¿ç”¨ `mantine-react-table` å®ç°é«˜çº§æ•°æ®è¡¨æ ¼
- æ”¯æŒæœç´¢ã€çŠ¶æ€ç­›é€‰ã€åˆ†ç±»ç­›é€‰
- æ‰¹é‡æ“ä½œå’Œå†…è”çŠ¶æ€åˆ‡æ¢
- è‡ªå®šä¹‰åˆ†é¡µç»„ä»¶

**æ–°å»ºæ–‡ç« é¡µ** (`/cms/posts/new`)ï¼š
- å“åº”å¼åŒæ å¸ƒå±€
- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆ
- å®Œæ•´è¡¨å•éªŒè¯å’ŒSEOè®¾ç½®
- è‰ç¨¿/å‘å¸ƒåŒé‡ä¿å­˜

**ç¼–è¾‘æ–‡ç« é¡µ** (`/cms/posts/[id]/edit`)ï¼š
- æ•°æ®é¢„å¡«å……å’Œæ™ºèƒ½æ›´æ–°
- æ–‡ç« ä¿¡æ¯å±•ç¤ºé¢æ¿
- æ™ºèƒ½ slug æ›´æ–°æœºåˆ¶

### 4. æ–°å¢ä¾èµ–

```json
{
  "mantine-react-table": "^1.3.4",
  "@mantine/dates": "^8.1.2", 
  "dayjs": "^1.11.x"
}
```

## æŠ€æœ¯é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: CMSæ¨¡å—tRPCæ„å»ºé”™è¯¯

**é”™è¯¯ç°è±¡**ï¼š
```
Could not resolve "@trpc/server"
src/api/post.ts:2:26:
2 â”‚ import { TRPCError } from '@trpc/server';
```

**åŸå› åˆ†æ**ï¼š
CMS æ¨¡å—åœ¨æ„å»ºæ—¶æ— æ³•è§£æ tRPC server ä¾èµ–ï¼Œå› ä¸º API ä»£ç ä¸åº”è¯¥åœ¨åŠŸèƒ½æ¨¡å—ä¸­æ„å»ºï¼Œåº”è¯¥åªåœ¨ä¸»åº”ç”¨ä¸­ä½¿ç”¨ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ `features/cms/tsup.config.ts` ä¸­æ·»åŠ  tRPC ä¾èµ–åˆ° external åˆ—è¡¨ï¼š
```typescript
external: [
  // ... å…¶ä»–ä¾èµ–
  "@trpc/server",
  "@trpc/client", 
  "@trpc/react-query",
  "next/navigation",
  "next-auth/react"
]
```

2. ä¿®æ”¹ `features/cms/src/index.ts`ï¼Œä¸å¯¼å‡º API è·¯ç”±ï¼š
```typescript
// ç§»é™¤: export * from './api';
// Export components
export * from './components';
// Export types  
export * from './types';
```

### é—®é¢˜2: Next.js 15 Webpacké…ç½®å…¼å®¹æ€§

**é”™è¯¯ç°è±¡**ï¼š
```
unhandledRejection TypeError: Cannot read properties of undefined (reading 'issuerLayer')
```

**åŸå› åˆ†æ**ï¼š
Next.js 15 ä¸­ webpack externals å¤„ç†æ–¹å¼å‘ç”Ÿå˜åŒ–ï¼Œå¤æ‚çš„ externals å‡½æ•°ä¸å†å…¼å®¹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
ç®€åŒ– `next.config.ts` ä¸­çš„ webpack é…ç½®ï¼š
```typescript
webpack: (config, { isServer }) => {
  if (isServer) {
    config.externals.push('bcryptjs');
  }
  return config;
}
```

### é—®é¢˜3: tRPCå¯¼å…¥è·¯å¾„é”™è¯¯

**é”™è¯¯ç°è±¡**ï¼š
```
Module not found: Can't resolve '../../trpc/react'
Module not found: Can't resolve '~/trpc/react'
```

**åŸå› åˆ†æ**ï¼š
CMS é¡µé¢ä¸­çš„ tRPC å¯¼å…¥è·¯å¾„ä¸æ­£ç¡®ï¼Œéƒ¨åˆ†ä½¿ç”¨äº†æœªé…ç½®çš„è·¯å¾„åˆ«åã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä¿®æ­£æ‰€æœ‰ CMS é¡µé¢çš„å¯¼å…¥è·¯å¾„ï¼š
```typescript
// é”™è¯¯: import { api } from '../../trpc/react';
// é”™è¯¯: import { api } from '~/trpc/react';

// æ­£ç¡®:
import { api } from '../../../trpc/react';      // categories
import { api } from '../../../../trpc/react';   // posts/new  
import { api } from '../../../../../trpc/react'; // posts/[id]/edit
```

### é—®é¢˜4: Next.js 15å¼‚æ­¥params

**é”™è¯¯ç°è±¡**ï¼š
```
Type 'Props' does not satisfy the constraint 'PageProps'.
Type '{ id: string; }' is missing properties: then, catch, finally
```

**åŸå› åˆ†æ**ï¼š
Next.js 15 ä¸­åŠ¨æ€è·¯ç”±çš„ `params` ç°åœ¨æ˜¯ Promise ç±»å‹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ›´æ–° `[id]/edit/page.tsx` çš„ç±»å‹å®šä¹‰å’Œå¤„ç†ï¼š
```typescript
interface Props {
  params: Promise<{ id: string; }>;
}

export default function EditPostPage({ params }: Props) {
  const [postId, setPostId] = React.useState<string>('');

  React.useEffect(() => {
    params.then((resolvedParams) => {
      setPostId(resolvedParams.id);
    });
  }, [params]);

  const { data: post } = api.post.getById.useQuery({ id: postId }, {
    enabled: !!postId,
  });
}
```

### é—®é¢˜5: useSearchParamséœ€è¦Suspenseè¾¹ç•Œ

**é”™è¯¯ç°è±¡**ï¼š
```
useSearchParams() should be wrapped in a suspense boundary at page "/login"
```

**åŸå› åˆ†æ**ï¼š
Next.js 15 è¦æ±‚ `useSearchParams()` å¿…é¡»è¢«åŒ…è£¹åœ¨ Suspense è¾¹ç•Œä¸­ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä¸ºè®¤è¯ç›¸å…³é¡µé¢æ·»åŠ  Suspense åŒ…è£…ï¼š
```typescript
import { Suspense } from 'react';

function LoginPageContent() {
  const searchParams = useSearchParams();
  // ... é¡µé¢å†…å®¹
}

export default function LoginPage() {
  return (
    <Suspense fallback={<Loader />}>
      <LoginPageContent />
    </Suspense>
  );
}
```

åŒæ—¶æ·»åŠ  `force-dynamic` é…ç½®ï¼š
```typescript
export const dynamic = 'force-dynamic';
```

### é—®é¢˜6: TypeScriptå’ŒESLintä¸¥æ ¼æ£€æŸ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä¸´æ—¶æ”¾å®½æ£€æŸ¥ä»¥å¿«é€ŸéªŒè¯åŠŸèƒ½ï¼š
```typescript
// next.config.ts
typescript: {
  ignoreBuildErrors: true,
},
eslint: {
  ignoreDuringBuilds: true,
},
```

## å½“å‰çŠ¶æ€

### âœ… å·²è§£å†³
1. CMS æ¨¡å—æ„å»ºé…ç½®é—®é¢˜
2. Next.js 15 webpack å…¼å®¹æ€§
3. tRPC å¯¼å…¥è·¯å¾„é—®é¢˜  
4. å¼‚æ­¥ params ç±»å‹é—®é¢˜
5. éƒ¨åˆ† useSearchParams Suspense é—®é¢˜

### ğŸŸ¡ éƒ¨åˆ†è§£å†³
1. useSearchParams é—®é¢˜ï¼ˆè¿˜æœ‰å¤šä¸ªè®¤è¯é¡µé¢éœ€è¦ä¿®å¤ï¼‰
2. è¿è¡Œæ—¶ 500 é”™è¯¯ï¼ˆå¯èƒ½ä¸ç»„ä»¶å…¼å®¹æ€§ç›¸å…³ï¼‰

### âœ… åŠŸèƒ½å®Œæˆåº¦
1. å®Œæ•´çš„æ–‡ç« æ•°æ®æ¨¡å‹
2. å®Œæ•´çš„ tRPC API è·¯ç”±
3. ä¸‰ä¸ªä¸»è¦ CMS é¡µé¢ï¼ˆåˆ—è¡¨ã€æ–°å»ºã€ç¼–è¾‘ï¼‰
4. å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆ
5. å“åº”å¼ UI è®¾è®¡

## å¼€å‘æœåŠ¡å™¨çŠ¶æ€

- âœ… å¼€å‘æœåŠ¡å™¨æˆåŠŸå¯åŠ¨ï¼ˆç«¯å£ 3000ï¼‰
- âš ï¸ éƒ¨åˆ†é¡µé¢ä»æœ‰è¿è¡Œæ—¶é”™è¯¯ï¼ˆ500ï¼‰
- âœ… ä¸»åº”ç”¨æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ï¼ˆdashboardé‡å®šå‘æ­£å¸¸ï¼‰

## æŠ€æœ¯å€ºåŠ¡å’Œåç»­è®¡åˆ’

### ç«‹å³éœ€è¦ä¿®å¤
1. å®Œæˆæ‰€æœ‰è®¤è¯é¡µé¢çš„ useSearchParams Suspense åŒ…è£…
2. è°ƒè¯•è¿è¡Œæ—¶ 500 é”™è¯¯ï¼Œå¯èƒ½çš„åŸå› ï¼š
   - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç»„ä»¶å…¼å®¹æ€§
   - ä¾èµ–ç‰ˆæœ¬å†²çª
   - æ•°æ®åº“è¿æ¥é—®é¢˜

### åŠŸèƒ½æ‰©å±•
1. æ ‡ç­¾ç®¡ç†æ¨¡å—
2. æ–‡ç« é¢„è§ˆåŠŸèƒ½
3. åª’ä½“åº“é›†æˆ
4. å‰å°å±•ç¤ºé¡µé¢

### ä»£ç è´¨é‡ä¼˜åŒ–
1. ä¿®å¤ TypeScript ç±»å‹é”™è¯¯
2. ä¿®å¤ ESLint è­¦å‘Š
3. æ·»åŠ å•å…ƒæµ‹è¯•
4. æ€§èƒ½ä¼˜åŒ–

## ç»éªŒæ€»ç»“

### Next.js 15å‡çº§è¦ç‚¹
1. **å¼‚æ­¥ params**: åŠ¨æ€è·¯ç”±å‚æ•°ç°åœ¨æ˜¯ Promise
2. **useSearchParams**: å¿…é¡»ä½¿ç”¨ Suspense åŒ…è£…
3. **webpacké…ç½®**: éœ€è¦ç®€åŒ– externals é…ç½®
4. **ç±»å‹æ£€æŸ¥**: æ›´ä¸¥æ ¼çš„ç±»å‹è¦æ±‚

### æ¶æ„è®¾è®¡åŸåˆ™
1. **æ¨¡å—åŒ–**: CMS åŠŸèƒ½æ¨¡å—ä¸åº”åŒ…å«æœåŠ¡å™¨ç«¯ä»£ç 
2. **æ„å»ºä¼˜åŒ–**: ä½¿ç”¨æ­£ç¡®çš„ external é…ç½®é¿å…é‡å¤æ‰“åŒ…
3. **ç±»å‹å®‰å…¨**: ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨çš„é‡è¦æ€§

### å¼€å‘å·¥ä½œæµ
1. **æ¸è¿›å¼ä¿®å¤**: å…ˆè§£å†³æ„å»ºé—®é¢˜ï¼Œå†è§£å†³è¿è¡Œæ—¶é—®é¢˜
2. **ä¸´æ—¶é…ç½®**: å¿…è¦æ—¶å¯ä»¥ä¸´æ—¶æ”¾å®½æ£€æŸ¥ä»¥å¿«é€ŸéªŒè¯åŠŸèƒ½
3. **æ–‡æ¡£è®°å½•**: åŠæ—¶è®°å½•æŠ€æœ¯å†³ç­–å’Œé—®é¢˜è§£å†³æ–¹æ¡ˆ

## å…³é”®æ–‡ä»¶å˜æ›´

### é…ç½®æ–‡ä»¶
- `apps/admin-dashboard/next.config.ts` - webpackå’Œæ„å»ºé…ç½®ä¼˜åŒ–
- `features/cms/tsup.config.ts` - externalä¾èµ–é…ç½®
- `features/cms/src/index.ts` - ç§»é™¤APIå¯¼å‡º

### æ•°æ®æ¨¡å‹
- `packages/db/prisma/schema.prisma` - æ–°å¢Post, Tag, PostTagæ¨¡å‹
- `features/cms/prisma/post.prisma` - æ–‡ç« ç›¸å…³æ•°æ®æ¨¡å‹

### APIè·¯ç”±
- `features/cms/src/api/post.ts` - å®Œæ•´çš„æ–‡ç« ç®¡ç†API
- `apps/admin-dashboard/server/api/root.ts` - é›†æˆpostè·¯ç”±

### å‰ç«¯é¡µé¢
- `apps/admin-dashboard/app/cms/posts/page.tsx` - æ–‡ç« åˆ—è¡¨é¡µ
- `apps/admin-dashboard/app/cms/posts/new/page.tsx` - æ–°å»ºæ–‡ç« é¡µ
- `apps/admin-dashboard/app/cms/posts/[id]/edit/page.tsx` - ç¼–è¾‘æ–‡ç« é¡µ

è¿™æ¬¡å¼€å‘è¿‡ç¨‹å±•ç°äº†ç°ä»£å‰ç«¯æŠ€æœ¯æ ˆå‡çº§æ—¶å¯èƒ½é‡åˆ°çš„å„ç§å…¼å®¹æ€§æŒ‘æˆ˜ï¼Œä»¥åŠç³»ç»Ÿæ€§è§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ³•è®ºã€‚ 