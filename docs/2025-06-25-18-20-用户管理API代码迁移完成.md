# ç”¨æˆ·ç®¡ç† API ä»£ç è¿ç§»å®Œæˆ

**æ—¶é—´**: 2025-06-25 18:20  
**ä»»åŠ¡**: ç”¨æˆ·ç®¡ç†æ¨¡å—é‡æ„ - ç¬¬äºŒæ­¥ï¼šè¿ç§»åç«¯ API (userRouter)

## è¿ç§»æ¦‚è¿°

å°†ç”¨æˆ·ç®¡ç†çš„ tRPC è·¯ç”±é€»è¾‘ä»ä¸»åº”ç”¨è¿ç§»åˆ°ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ï¼Œå®ç° API å±‚çš„æ¨¡å—åŒ–æ¶æ„ã€‚

## è¿ç§»å†…å®¹

### 1. åˆ›å»ºç±»å‹å®šä¹‰æ–‡ä»¶

**æ–°å»º**: `features/user-management/api/types.ts`

#### æ ¸å¿ƒç±»å‹å®šä¹‰
```typescript
// ç”¨æˆ·è§’è‰²å’ŒçŠ¶æ€æšä¸¾
export const UserRole = z.enum(['USER', 'ADMIN']);
export const UserStatus = z.enum(['ACTIVE', 'BANNED']);

// ç”¨æˆ·åŸºç¡€ä¿¡æ¯æ¥å£
export interface User {
  id: string;
  name: string | null;
  email: string;
  role: UserRole;
  status: UserStatus;
  createdAt: Date;
  updatedAt: Date;
}

// Zod éªŒè¯Schema
export const userCreateSchema = z.object({...});
export const userUpdateSchema = z.object({...});
export const userListSchema = z.object({...});
```

#### å“åº”ç±»å‹å®šä¹‰
```typescript
export interface UserListResponse {
  items: User[];
  nextCursor?: string;
  hasNextPage: boolean;
}

export interface UserStatsResponse {
  total: number;
  active: number;
  banned: number;
  admin: number;
  regular: number;
}
```

### 2. åˆ›å»ºè·¯ç”±å®šä¹‰æ–‡ä»¶

**æ–°å»º**: `features/user-management/api/routes.ts`

#### ä¾èµ–æ³¨å…¥æ¨¡å¼
ä¸ºäº†è§£å†³æ¨¡å—é—´ä¾èµ–é—®é¢˜ï¼Œé‡‡ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼ï¼š

```typescript
export function createUserRouter(deps: {
  createTRPCRouter: typeof createTRPCRouter;
  publicProcedure: typeof publicProcedure;
}) {
  const { createTRPCRouter, publicProcedure } = deps;
  
  return createTRPCRouter({
    // æ‰€æœ‰è·¯ç”±å®šä¹‰...
  });
}
```

#### è¿ç§»çš„è·¯ç”±åŠŸèƒ½
- âœ… `list` - ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ï¼‰
- âœ… `getById` - æ ¹æ®IDè·å–ç”¨æˆ·
- âœ… `create` - åˆ›å»ºæ–°ç”¨æˆ·
- âœ… `update` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯  
- âœ… `delete` - åˆ é™¤ç”¨æˆ·
- âœ… `deleteMany` - æ‰¹é‡åˆ é™¤ç”¨æˆ·
- âœ… `getStats` - è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯

### 3. æ›´æ–°APIæ¨¡å—å¯¼å‡º

**æ›´æ–°**: `features/user-management/api/index.ts`

```typescript
// å¯¼å‡ºæ‰€æœ‰ç±»å‹å’Œè·¯ç”±åˆ›å»ºå‡½æ•°
export * from './routes';
export * from './types';

// ä¸ºå‘åå…¼å®¹æ€§åˆ›å»ºé»˜è®¤è·¯ç”±å®ä¾‹
export const userRouter = createUserRouter({
  createTRPCRouter,
  publicProcedure,
});
```

### 4. æ›´æ–°ä¸»åº”ç”¨ä¾èµ–

#### æ·»åŠ åŠŸèƒ½æ¨¡å—ä¾èµ–
**ä¿®æ”¹**: `apps/admin-dashboard/package.json`

```json
{
  "dependencies": {
    "@damon-stack/feature-user-management": "workspace:*"
  }
}
```

#### æ›´æ–°æ ¹è·¯ç”±å¯¼å…¥
**ä¿®æ”¹**: `apps/admin-dashboard/server/api/root.ts`

```typescript
// ä¿®æ”¹å‰
import { userRouter } from './routers/user';

// ä¿®æ”¹å  
import { userRouter } from '@damon-stack/feature-user-management/api';
```

### 5. æ¸…ç†åŸå§‹æ–‡ä»¶

**åˆ é™¤**: `apps/admin-dashboard/server/api/routers/user.ts`
- åŸå§‹ç”¨æˆ·è·¯ç”±æ–‡ä»¶å·²å®Œå…¨è¿ç§»ï¼Œå¯ä»¥å®‰å…¨åˆ é™¤

## æŠ€æœ¯äº®ç‚¹

### 1. ä¾èµ–æ³¨å…¥æ¨¡å¼

é‡‡ç”¨ä¾èµ–æ³¨å…¥è§£å†³æ¨¡å—é—´ä¾èµ–é—®é¢˜ï¼š

```typescript
// åŠŸèƒ½æ¨¡å—ä¸ç›´æ¥ä¾èµ–ä¸»åº”ç”¨çš„ tRPC
// è€Œæ˜¯é€šè¿‡å‚æ•°æ³¨å…¥çš„æ–¹å¼è·å–ä¾èµ–
export function createUserRouter(deps: {
  createTRPCRouter: typeof createTRPCRouter;
  publicProcedure: typeof publicProcedure;
}) {
  // ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–åˆ›å»ºè·¯ç”±
}
```

**ä¼˜åŠ¿**:
- ğŸ”„ **è§£è€¦**: åŠŸèƒ½æ¨¡å—ä¸ä¸»åº”ç”¨è§£è€¦
- ğŸ§ª **å¯æµ‹è¯•**: ä¾¿äºå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- ğŸ”§ **çµæ´»**: å¯ä»¥æ³¨å…¥ä¸åŒçš„ tRPC å®ä¾‹
- â™»ï¸ **å¯å¤ç”¨**: å¯ä»¥åœ¨ä¸åŒçš„åº”ç”¨ä¸­å¤ç”¨

### 2. ç±»å‹å®‰å…¨ä¿éšœ

å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰ï¼š

```typescript
// å¼ºç±»å‹çš„æŸ¥è¯¢å“åº”
.query(async ({ input, ctx }): Promise<UserListResponse> => {
  // ç¡®ä¿è¿”å›ç±»å‹ä¸å®šä¹‰ä¸€è‡´
});

// ç±»å‹å®‰å…¨çš„ç”¨æˆ·å¯¹è±¡
return user as User;
```

### 3. å‘åå…¼å®¹æ€§

æä¾›é»˜è®¤å¯¼å‡ºä»¥ä¿æŒå…¼å®¹ï¼š

```typescript
// ä¸»åº”ç”¨å¯ä»¥ç›´æ¥å¯¼å…¥ä½¿ç”¨ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
import { userRouter } from '@damon-stack/feature-user-management/api';
```

## å¯¼å…¥è·¯å¾„å˜åŒ–

### ä¸»åº”ç”¨ç«¯å˜åŒ–

```typescript
// ä¿®æ”¹å‰
import { userRouter } from './routers/user';

// ä¿®æ”¹å
import { userRouter } from '@damon-stack/feature-user-management/api';
```

### åŠŸèƒ½æ¨¡å—å†…éƒ¨

```typescript
// ç±»å‹å¯¼å…¥
import { 
  User, 
  UserCreateInput, 
  userCreateSchema 
} from './types';

// è·¯ç”±åˆ›å»º
import { createUserRouter } from './routes';
```

## æ–‡ä»¶å˜åŒ–æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `features/user-management/api/types.ts` - ç±»å‹å®šä¹‰
- âœ… `features/user-management/api/routes.ts` - è·¯ç”±é€»è¾‘
- âœ… `features/user-management/api/index.ts` - æ¨¡å—å¯¼å‡ºï¼ˆæ›´æ–°ï¼‰

### ä¿®æ”¹æ–‡ä»¶
- ğŸ”„ `apps/admin-dashboard/package.json` - æ·»åŠ ä¾èµ–
- ğŸ”„ `apps/admin-dashboard/server/api/root.ts` - æ›´æ–°å¯¼å…¥

### åˆ é™¤æ–‡ä»¶
- ğŸ—‘ï¸ `apps/admin-dashboard/server/api/routers/user.ts` - åŸå§‹è·¯ç”±æ–‡ä»¶

## åŠŸèƒ½éªŒè¯

### API æ¥å£ä¿æŒä¸å˜
æ‰€æœ‰ API æ¥å£çš„è°ƒç”¨æ–¹å¼ä¿æŒå®Œå…¨ä¸€è‡´ï¼š

```typescript
// å®¢æˆ·ç«¯è°ƒç”¨æ–¹å¼ä¸å˜
trpc.user.list.useQuery({ limit: 10 });
trpc.user.create.useMutation();
trpc.user.update.useMutation();
trpc.user.delete.useMutation();
```

### è·¯ç”±å‘½åç©ºé—´ä¸€è‡´
```typescript
export const appRouter = createTRPCRouter({
  user: userRouter,  // å‘½åç©ºé—´ä¿æŒ 'user'
  // ...
});
```

## æ¶æ„ä¼˜åŠ¿

### 1. æ¨¡å—åŒ–è§£è€¦
- API é€»è¾‘ä¸ä¸»åº”ç”¨åˆ†ç¦»
- åŠŸèƒ½æ¨¡å—å¯ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
- å‡å°‘ä¸»åº”ç”¨çš„ä»£ç å¤æ‚åº¦

### 2. ä»£ç å¤ç”¨æ€§
- åŠŸèƒ½æ¨¡å—å¯ä»¥åœ¨å¤šä¸ªåº”ç”¨ä¸­ä½¿ç”¨
- ç»Ÿä¸€çš„ API æ¥å£å’Œç±»å‹å®šä¹‰
- ä¾¿äºç»´æŠ¤å’Œå‡çº§

### 3. ç±»å‹å®‰å…¨
- ç«¯åˆ°ç«¯çš„ç±»å‹å®‰å…¨ä¿éšœ
- ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
- IDE æ™ºèƒ½æç¤ºæ”¯æŒ

### 4. å¼€å‘ä½“éªŒ
- æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ
- ç‹¬ç«‹çš„ç‰ˆæœ¬æ§åˆ¶
- ä¾¿äºå›¢é˜Ÿåä½œå¼€å‘

## è¿ç§»çŠ¶æ€

- [x] **æ­¥éª¤1**: åˆ›å»ºæ¨¡å—ç»“æ„ âœ…
- [x] **æ­¥éª¤2**: è¿ç§» API ä»£ç  âœ…
- [ ] **æ­¥éª¤3**: è¿ç§»ç»„ä»¶ä»£ç 
- [ ] **æ­¥éª¤4**: æ›´æ–°ä¸»åº”ç”¨ä¾èµ–
- [ ] **æ­¥éª¤5**: æµ‹è¯•å’ŒéªŒè¯

## ä¸‹ä¸€æ­¥è®¡åˆ’

æ¥ä¸‹æ¥å°†è¿›è¡Œç¬¬ä¸‰æ­¥ï¼š**è¿ç§»ç»„ä»¶ä»£ç **ï¼Œå°†ç”¨æˆ·ç®¡ç†ç›¸å…³çš„ React ç»„ä»¶ä»ä¸»åº”ç”¨è¿ç§»åˆ°åŠŸèƒ½æ¨¡å—ä¸­ã€‚

## çŠ¶æ€

âœ… **å®Œæˆ** - ç”¨æˆ·ç®¡ç† API ä»£ç å·²æˆåŠŸè¿ç§»åˆ°åŠŸèƒ½æ¨¡å—ï¼Œå®ç°äº† API å±‚çš„æ¨¡å—åŒ–æ¶æ„ 